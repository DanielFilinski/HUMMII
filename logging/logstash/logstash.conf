# Logstash Configuration for Hummii Production
# Processes logs from Filebeat and sends to Elasticsearch

input {
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs
  if [fields][log_type] == "json" {
    json {
      source => "message"
    }
  }

  # Parse timestamp
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss.SSS" ]
    target => "@timestamp"
  }

  # Mask PII (Personal Identifiable Information)
  # Email addresses
  mutate {
    gsub => [
      "message", "(?i)([a-z0-9._%+-]+)@([a-z0-9.-]+)\.([a-z]{2,})", "[EMAIL_MASKED]"
    ]
  }

  # Phone numbers (Canadian format)
  mutate {
    gsub => [
      "message", "(?i)(\+?1)?[-.\s]?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})", "[PHONE_MASKED]"
    ]
  }

  # Credit card numbers
  mutate {
    gsub => [
      "message", "(?i)(\d{4}[-.\s]?){3}\d{4}", "[CARD_MASKED]"
    ]
  }

  # Social Insurance Numbers (SIN)
  mutate {
    gsub => [
      "message", "(?i)(\d{3}[-.\s]?){2}\d{3}", "[SIN_MASKED]"
    ]
  }

  # Add correlation ID if not present
  if ![correlation_id] {
    uuid {
      target => "correlation_id"
    }
  }

  # Add environment tag
  mutate {
    add_field => { "environment" => "production" }
  }

  # Security event detection
  if [message] =~ /(?i)(password|secret|token|key|credential|auth)/ {
    mutate {
      add_tag => ["security_event"]
    }
  }

  # Error detection
  if [level] == "error" or [level] == "fatal" {
    mutate {
      add_tag => ["error"]
    }
  }

  # Warning detection
  if [level] == "warn" {
    mutate {
      add_tag => ["warning"]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "hummii-logs-%{+YYYY.MM.dd}"
    template_name => "hummii-logs"
    template => "/usr/share/logstash/templates/hummii-logs-template.json"
    template_overwrite => true
  }

  # Send security events to separate index
  if "security_event" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "hummii-security-events-%{+YYYY.MM.dd}"
    }
  }

  # Debug output (remove in production)
  # stdout {
  #   codec => rubydebug
  # }
}

