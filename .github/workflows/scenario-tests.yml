name: Scenario Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  scenario-tests:
    name: Run Scenario Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: hummii_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./api
        run: npm ci

      - name: ğŸ”„ Generate Prisma Client
        working-directory: ./api
        run: npx prisma generate

      - name: ğŸ—„ï¸ Run database migrations
        working-directory: ./api
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/hummii_test

      - name: ğŸŒ± Seed database (optional)
        working-directory: ./api
        run: npm run prisma:seed || true
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/hummii_test

      - name: ğŸš€ Start API (background)
        working-directory: ./api
        run: |
          npm run start:prod &
          echo "Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… API is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/hummii_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          JWT_SECRET: test-jwt-secret
          JWT_REFRESH_SECRET: test-refresh-secret

      - name: ğŸ¯ Run scenario tests
        working-directory: ./api
        run: npm run test:scenarios
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/hummii_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          JWT_SECRET: test-jwt-secret
          JWT_REFRESH_SECRET: test-refresh-secret

      - name: ğŸ“Š Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scenario-test-reports
          path: api/test-reports/scenarios/
          retention-days: 30

      - name: ğŸ“ˆ Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: api/test-reports/scenarios/junit-scenarios.xml
          check_name: Scenario Test Results
          comment_title: ğŸ¯ Scenario Test Results

      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'api/test-reports/scenarios/scenario-tests-report.html';
            
            let comment = '## ğŸ¯ Scenario Test Results\n\n';
            
            if (fs.existsSync(reportPath)) {
              comment += 'âœ… Tests completed! View the detailed [HTML report](' + 
                         '${{ steps.upload-artifact.outputs.artifact-url }}' + 
                         ') in artifacts.\n\n';
            } else {
              comment += 'âŒ Test execution failed. Check the workflow logs.\n\n';
            }
            
            comment += 'ğŸ“Š [View full workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: âŒ Fail if tests failed
        if: failure()
        run: |
          echo "::error::Scenario tests failed!"
          exit 1
