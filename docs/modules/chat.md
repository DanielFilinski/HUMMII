ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ! Ð­Ñ‚Ð¾ **Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ¿Ñ€Ð¾Ñ‰Ð°ÐµÑ‚** Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ñ‡Ð°Ñ‚Ð° Ð¸ **ÑƒÑÐ¸Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ Ð±Ð¸Ð·Ð½ÐµÑ-Ð¼Ð¾Ð´ÐµÐ»Ð¸**. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸.

## ðŸ“ **ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸: Ð§Ð°Ñ‚ Ð‘Ð•Ð— Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸ Ð¼ÐµÐ´Ð¸Ð°**

### âœ… **Ð§Ñ‚Ð¾ Ð’ÐšÐ›Ð®Ð§Ð˜Ð¢Ð¬ (Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´):**

#### 1. **Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ**
- âœ… ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
- âœ… Ð”Ð¾ 2000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÑÐ¿Ð°Ð¼Ð°)
- âœ… Read receipts (Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð¾/Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾)
- âœ… Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸
- âœ… Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ "Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚..."

#### 2. **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ**
- âœ… **Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð¾Ð²** - Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¼ÐµÐ½Ð° Ð½Ð° `***`
- âœ… **Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° email** - Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¼ÐµÐ½Ð° Ð½Ð° `***`
- âœ… **Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÑÑÑ‹Ð»Ð¾Ðº Ð½Ð° Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ñ‹** (Telegram, WhatsApp, Viber)
- âœ… **Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÑÐ¾Ñ†ÑÐµÑ‚ÐµÐ¹** (@instagram, @facebook, etc.)
- âœ… **Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð½ÐµÑ†ÐµÐ½Ð·ÑƒÑ€Ð½Ð¾Ð¹ Ð»ÐµÐºÑÐ¸ÐºÐ¸**

#### 3. **Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ**
- âœ… ÐšÐ½Ð¾Ð¿ÐºÐ° "ÐŸÐ¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒÑÑ" Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
- âœ… Ð¨Ð¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Ñ‚Ñ€Ð°Ð½Ð·Ð¸Ñ‚Ðµ (HTTPS + WSS)
- âœ… ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ð·Ð°ÐºÐ°Ð·Ñƒ
- âœ… Ð§Ð°Ñ‚ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· N Ð´Ð½ÐµÐ¹ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸)

#### 4. **Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ**
- âœ… **Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð²ÐµÑ‡Ð½Ð¾** (Ð´Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°)
- âœ… **ÐÐµÐ»ÑŒÐ·Ñ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ** (Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð² ÑÐ¿Ð¾Ñ€Ð°Ñ…)
- âœ… **ÐœÐ¾Ð¶Ð½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ** Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚ (Ñ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¾Ð¹ "Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾")
- âœ… **Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸** (PIPEDA compliance) - ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð² PDF/TXT

---

### âŒ **Ð§Ñ‚Ð¾ Ð˜Ð¡ÐšÐ›Ð®Ð§Ð˜Ð¢Ð¬:**

- âŒ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
- âŒ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° PDF/Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
- âŒ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð²Ð¸Ð´ÐµÐ¾
- âŒ ÐÑƒÐ´Ð¸Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
- âŒ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð»ÑŽÐ±Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð°
- âŒ Ð¡Ñ‚Ð¸ÐºÐµÑ€Ñ‹/ÑÐ¼Ð¾Ð´Ð·Ð¸-Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸)
- âŒ Ð“Ð¸Ñ„ÐºÐ¸
- âŒ Ð“ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ

---

### ðŸ’¡ **ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° Ñ‚Ð°ÐºÐ¾Ð³Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð°:**

#### **Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ:**
1. âœ… **ÐŸÑ€Ð¾ÑÑ‚Ð¾Ñ‚Ð° Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸** - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ WebSocket + Ñ‚ÐµÐºÑÑ‚
2. âœ… **ÐÐµÑ‚ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²** - Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½ S3/Cloudinary
3. âœ… **Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°** - Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ñ€Ð°Ñ„Ð¸Ðº
4. âœ… **Ð›ÐµÐ³ÐºÐ°Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ** - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚, Ð±ÐµÐ· AI Ð´Ð»Ñ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
5. âœ… **Ð”ÐµÑˆÐµÐ²Ð»Ðµ** - Ð½ÐµÑ‚ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð½Ð° Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¼ÐµÐ´Ð¸Ð°

#### **Ð‘Ð¸Ð·Ð½ÐµÑ:**
1. âœ… **Ð¡Ð¸Ð»ÑŒÐ½ÐµÐµ Ð·Ð°Ñ‰Ð¸Ñ‚Ð°** - Ð±ÐµÐ· Ñ„Ð°Ð¹Ð»Ð¾Ð² ÑÐ»Ð¾Ð¶Ð½ÐµÐµ Ð¾Ð±Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°Ð¼Ð¸ (Ð½ÐµÑ‚ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð²Ð¸Ð·Ð¸Ñ‚Ð¾Ðº)
2. âœ… **ÐœÐµÐ½ÑŒÑˆÐµ Ð·Ð»Ð¾ÑƒÐ¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ð¹** - Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾ Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð¾Ð¼
3. âœ… **Ð¤Ð¾ÐºÑƒÑ Ð½Ð° Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ðµ** - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ñ‹Ð½ÑƒÐ¶Ð´ÐµÐ½Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾
4. âœ… **ÐŸÑ€Ð¾Ñ‰Ðµ Ð¼Ð¾Ð´ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ** - Ñ‚ÐµÐºÑÑ‚ Ð»ÐµÐ³Ñ‡Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ

#### **UX:**
1. âœ… **Ð‘Ñ‹ÑÑ‚Ñ€ÐµÐµ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ**
2. âœ… **ÐœÐµÐ½ÑŒÑˆÐµ Ð¾Ñ‚Ð²Ð»ÐµÐºÐ°ÐµÑ‚** - Ñ‡Ð°Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ†Ð¸Ð¸, Ð° Ð½Ðµ Ð´Ð»Ñ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
3. âœ… **Ð§ÐµÑ‚ÐºÐ°Ñ Ñ†ÐµÐ»ÑŒ** - Ð¾Ð±ÑÑƒÐ´Ð¸Ñ‚ÑŒ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð° Ð¸ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒÑÑ Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ðµ

---

### ðŸŽ¯ **ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹ Ð´Ð»Ñ Ð¾Ð±Ð¼ÐµÐ½Ð° Ð¼ÐµÐ´Ð¸Ð°:**

Ð Ð°Ð· Ñ‡Ð°Ñ‚ Ð±ÐµÐ· Ñ„Ð°Ð¹Ð»Ð¾Ð², Ð½ÑƒÐ¶Ð½Ñ‹ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹ Ð´Ð»Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ñ… ÐºÐµÐ¹ÑÐ¾Ð²:

#### **1. ÐŸÐ¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»Ñ**
```
ÐšÐ»Ð¸ÐµÐ½Ñ‚: "ÐŸÐ¾ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð²Ð°ÑˆÐ¸Ñ… Ñ€Ð°Ð±Ð¾Ñ‚"
Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: "Ð’ÑÐµ Ð¼Ð¾Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð² Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ â†’ [ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾]"
```
- Ð’ Ñ‡Ð°Ñ‚Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ **Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑŽÑŽ ÑÑÑ‹Ð»ÐºÑƒ** Ð½Ð° ÑÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ/Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾

#### **2. Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°**
```
ÐšÐ»Ð¸ÐµÐ½Ñ‚: "Ð’Ð¾Ñ‚ Ñ„Ð¾Ñ‚Ð¾ Ñ‚Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ Ð¾Ñ‚Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"
```
- **Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** ÐŸÑ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð·Ð°ÐºÐ°Ð·Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¾ 5 Ñ„Ð¾Ñ‚Ð¾
- Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð²Ð¸Ð´Ð¸Ñ‚ Ð¸Ñ… Ð² ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐµ Ð·Ð°ÐºÐ°Ð·Ð°, Ð½Ðµ Ð² Ñ‡Ð°Ñ‚Ðµ

#### **3. Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ (Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€, ÑÐ¼ÐµÑ‚Ð°)**
```
Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: "Ð’Ð¾Ñ‚ ÑÐ¼ÐµÑ‚Ð° Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹"
```
- **Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** Ð’ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ "Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ¼ÐµÑ‚Ñƒ" Ð¿Ñ€ÑÐ¼Ð¾ Ð½Ð° Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ðµ
- Ð¡Ð¼ÐµÑ‚Ð° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ð² ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐµ Ð·Ð°ÐºÐ°Ð·Ð°, Ð¾Ð±Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð²Ð¸Ð´ÑÑ‚ Ð¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽÑ‚

---

### ðŸ“Š **ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ñ‡Ð°Ñ‚Ð°:**

```typescript
// ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ ÑÑ…ÐµÐ¼Ð°
interface ChatMessage {
  id: string;
  chatId: string;
  orderId: string;
  
  senderId: string;
  recipientId: string;
  
  // Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚
  content: string; // Ð¾Ñ‚Ð¼Ð¾Ð´ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚
  originalContent: string; // Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð»Ð¾Ð³Ð¾Ð²
  
  // ÐœÐ¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ
  isModerated: boolean;
  moderationFlags?: ('phone' | 'email' | 'link' | 'profanity')[];
  
  // Ð¡Ñ‚Ð°Ñ‚ÑƒÑ
  status: 'sent' | 'delivered' | 'read';
  
  // Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  isEdited: boolean;
  editedAt?: Date;
  
  createdAt: Date;
}

interface Chat {
  id: string;
  orderId: string;
  clientId: string;
  contractorId: string;
  
  // Ð¡Ñ‚Ð°Ñ‚ÑƒÑ
  isActive: boolean; // Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ?
  closedAt?: Date; // Ð·Ð°ÐºÑ€Ñ‹Ñ‚ Ñ‡ÐµÑ€ÐµÐ· N Ð´Ð½ÐµÐ¹ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
  
  // ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ
  lastMessageAt: Date;
  unreadCount: { [userId: string]: number };
  
  createdAt: Date;
}
```

---

### ðŸš€ **Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ ÑÑ‚ÐµÐº Ð´Ð»Ñ Ñ‡Ð°Ñ‚Ð°:**

#### **Ð§Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾:**
- âœ… Socket.io (WebSocket)
- âœ… PostgreSQL (Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹)
- âœ… Redis (ÐºÑÑˆ Ð¾Ð½Ð»Ð°Ð¹Ð½-ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð², typing indicators)
- âœ… ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ‚ÐµÐºÑÑ‚Ð°

#### **Ð§Ñ‚Ð¾ ÐÐ• Ð½ÑƒÐ¶Ð½Ð¾:**
- âŒ AWS S3 / Cloudinary (Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ)
- âŒ CDN Ð´Ð»Ñ Ð¼ÐµÐ´Ð¸Ð°
- âŒ Image optimization
- âŒ Virus scanning Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²
- âŒ Ð ÐµÐ·ÐµÑ€Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÑÑ‚Ð° Ð¿Ð¾Ð´ Ñ„Ð°Ð¹Ð»Ñ‹

---

### âš¡ **ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°:**

#### **Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ…:**

```typescript
// Ð§Ñ‚Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¾
âœ… ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚
âœ… Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸ (ðŸ˜Š ðŸ‘ âœ…)
âœ… ÐŸÐµÑ€ÐµÐ½Ð¾ÑÑ‹ ÑÑ‚Ñ€Ð¾Ðº
âœ… Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸ (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ)

// Ð§Ñ‚Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¼Ð¾Ð´ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ
âš ï¸ Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½Ñ‹ â†’ ***
âš ï¸ Email â†’ ***
âš ï¸ Ð’Ð½ÐµÑˆÐ½Ð¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸ â†’ [ÑÑÑ‹Ð»ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°]
âš ï¸ @ÑÐ¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹ÐµÑÐµÑ‚Ð¸ â†’ ***

// Ð§Ñ‚Ð¾ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾
âŒ Ð¡Ð¿Ð°Ð¼ (Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ 3+ Ñ€Ð°Ð·Ð°)
âŒ ÐÐµÑ†ÐµÐ½Ð·ÑƒÑ€Ð½Ð°Ñ Ð»ÐµÐºÑÐ¸ÐºÐ°
âŒ Ð£Ð³Ñ€Ð¾Ð·Ñ‹/Ð¾ÑÐºÐ¾Ñ€Ð±Ð»ÐµÐ½Ð¸Ñ
```

---

### ðŸ“‹ **Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹:**

| Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ | Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ? | ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° |
|---------|-----------|---------|
| Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ | âœ… | ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ |
| Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ | âŒ | **ÐÐµ Ð½ÑƒÐ¶Ð½Ñ‹** - Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾ Ð² Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ |
| PDF/Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ | âŒ | **ÐÐµ Ð½ÑƒÐ¶Ð½Ñ‹** - ÑÐ¼ÐµÑ‚Ð° Ð½Ð° Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ðµ |
| Ð¤Ð°Ð¹Ð»Ñ‹ Ð»ÑŽÐ±Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð° | âŒ | **ÐÐµ Ð½ÑƒÐ¶Ð½Ñ‹** |
| Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸ | âœ… | UX, ÑÐ¼Ð¾Ñ†Ð¸Ð¸ |
| Ð¡Ñ‚Ð¸ÐºÐµÑ€Ñ‹/GIF | âŒ | ÐžÑ‚Ð²Ð»ÐµÐºÐ°ÑŽÑ‚ Ð¾Ñ‚ Ð±Ð¸Ð·Ð½ÐµÑÐ° |
| Read receipts | âœ… | ÐŸÑ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒ |
| ÐžÐ½Ð»Ð°Ð¹Ð½-ÑÑ‚Ð°Ñ‚ÑƒÑ | âœ… | UX |
| "ÐŸÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚..." | âœ… | UX |
| Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð²ÐµÑ‡Ð½Ð¾ | âœ… | Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð² ÑÐ¿Ð¾Ñ€Ð°Ñ… |
| Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ | âŒ | Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð² ÑÐ¿Ð¾Ñ€Ð°Ñ… |
| Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (5 Ð¼Ð¸Ð½) | âœ… | Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾Ð¿ÐµÑ‡Ð°Ñ‚ÐºÐ¸ |
| Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸ | âœ… | PIPEDA |
| ÐÐ²Ñ‚Ð¾Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ | âœ… | **ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾** |
| Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸ | âœ… | ÐÐ° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸/Ð·Ð°ÐºÐ°Ð·Ñ‹ |
| Ð’Ð½ÐµÑˆÐ½Ð¸Ðµ ÑÑÑ‹Ð»ÐºÐ¸ | âŒ | Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÑŽÑ‚ÑÑ |

---

### ðŸŽ¯ **MVP Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°):**

```typescript
// 1. WebSocket events
socket.on('send_message', { orderId, content })
socket.on('message_sent', { message })
socket.on('message_read', { messageId })
socket.on('typing', { orderId, userId })

// 2. REST API Ð´Ð»Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
GET /chats/:orderId/messages
POST /chats/:orderId/messages
PATCH /chats/:orderId/messages/:id (Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 5 Ð¼Ð¸Ð½)
POST /chats/:orderId/export (ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ PDF)

// 3. ÐœÐ¾Ð´ÐµÑ€Ð°Ñ†Ð¸Ñ (middleware)
function moderateMessage(text: string): {
  content: string;
  isModerated: boolean;
  flags: string[];
}
```

---

### âœ¨ **Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„Ð¸ÑˆÐºÐ¸ Ð´Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°:**

1. **Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹** (Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹):
   ```
   Ð”Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¹:
   - "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð·Ð°ÐºÐ°Ð·! ÐšÐ¾Ð³Ð´Ð° ÑƒÐ´Ð¾Ð±Ð½Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒÑÑ?"
   - "Ð¯ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ñ€Ð¸ÑÑ‚ÑƒÐ¿Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ñ‚Ñ€Ð°. ÐŸÐ¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚?"
   - "Ð£Ñ‚Ð¾Ñ‡Ð½Ð¸Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð°Ð´Ñ€ÐµÑ"
   
   Ð”Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²:
   - "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ñ‚ÐºÐ»Ð¸Ðº! Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¾Ð±ÑÑƒÐ´Ð¸Ð¼ Ð´ÐµÑ‚Ð°Ð»Ð¸"
   - "ÐšÐ¾Ð³Ð´Ð° Ð²Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ñ€Ð¸ÐµÑ…Ð°Ñ‚ÑŒ Ð½Ð° Ð¾ÑÐ¼Ð¾Ñ‚Ñ€?"
   - "Ð—Ð°ÐºÐ°Ð· Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½, ÑÐ¿Ð°ÑÐ¸Ð±Ð¾!"
   ```

2. **Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ**:
   ```
   ðŸ“‹ "Ð—Ð°ÐºÐ°Ð· ÑÐ¾Ð·Ð´Ð°Ð½"
   âœ… "Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€Ð¸Ð½ÑÐ» Ð·Ð°ÐºÐ°Ð·"
   ðŸ’° "ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð°"
   â­ "ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¾ÑÑ‚Ð°Ð²Ð¸Ð» Ð¾Ñ‚Ð·Ñ‹Ð²"
   ```

3. **Ð£Ð¼Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ**:
   - Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° 24 Ñ‡Ð°ÑÐ° â†’ Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ñ‚ÑŒ
   - Ð•ÑÐ»Ð¸ Ð·Ð°ÐºÐ°Ð· ÑÐºÐ¾Ñ€Ð¾ Ð½Ð°Ñ‡Ð½ÐµÑ‚ÑÑ â†’ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ

---

**Ð˜Ñ‚Ð¾Ð³Ð¾:** Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±ÐµÐ· Ð¼ÐµÐ´Ð¸Ð° - ÑÑ‚Ð¾ **Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ** Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹:
- âœ… ÐŸÑ€Ð¾Ñ‰Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ
- âœ… Ð”ÐµÑˆÐµÐ²Ð»Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ
- âœ… Ð¡Ð¸Ð»ÑŒÐ½ÐµÐµ Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð±Ð¸Ð·Ð½ÐµÑ-Ð¼Ð¾Ð´ÐµÐ»Ð¸
- âœ… Ð¤Ð¾ÐºÑƒÑ Ð½Ð° ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ†Ð¸Ð¸, Ð° Ð½Ðµ Ð½Ð° Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸
- âœ… Ð›ÐµÐ³Ñ‡Ðµ Ð¼Ð¾Ð´ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ

Ð­Ñ‚Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€! ðŸŽ¯

---

## ðŸ” **WebSocket Security**

### Authentication

**JWT Authentication for WebSocket Connections:**

```typescript
import { WebSocketGateway, WebSocketServer, OnGatewayConnection } from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { JwtService } from '@nestjs/jwt';

@WebSocketGateway({
  cors: {
    origin: process.env.FRONTEND_URL,
    credentials: true,
  },
  namespace: '/chat',
})
export class ChatGateway implements OnGatewayConnection {
  @WebSocketServer()
  server: Server;

  constructor(
    private jwtService: JwtService,
    private usersService: UsersService,
  ) {}

  async handleConnection(client: Socket) {
    try {
      // Extract token from handshake
      const token = client.handshake.auth.token || client.handshake.headers.authorization?.split(' ')[1];

      if (!token) {
        throw new UnauthorizedException('No token provided');
      }

      // Verify JWT
      const payload = this.jwtService.verify(token);
      const user = await this.usersService.findOne(payload.sub);

      if (!user) {
        throw new UnauthorizedException('Invalid token');
      }

      // Attach user to socket
      client.data.user = user;

      // Join user's personal room
      client.join(`user:${user.id}`);

      // Set online status
      await this.setOnlineStatus(user.id, true);

      this.logger.log(`Client connected: ${user.id}`);
    } catch (error) {
      this.logger.error('WebSocket auth failed:', error);
      client.disconnect();
    }
  }

  async handleDisconnect(client: Socket) {
    const user = client.data.user;
    if (user) {
      await this.setOnlineStatus(user.id, false);
      this.logger.log(`Client disconnected: ${user.id}`);
    }
  }
}
```

### Rate Limiting

**Prevent message spam:**

```typescript
import { RateLimiterMemory } from 'rate-limiter-flexible';

@WebSocketGateway()
export class ChatGateway {
  private rateLimiter = new RateLimiterMemory({
    points: 20, // 20 messages
    duration: 60, // per 60 seconds
  });

  @SubscribeMessage('send_message')
  async handleSendMessage(
    @ConnectedSocket() client: Socket,
    @MessageBody() data: SendMessageDto,
  ) {
    const user = client.data.user;

    try {
      // Check rate limit
      await this.rateLimiter.consume(user.id);
    } catch (error) {
      throw new WsException('Rate limit exceeded. Please slow down.');
    }

    // Process message
    return this.chatService.sendMessage({ ...data, senderId: user.id });
  }
}
```

### Authorization (Order Access)

**Ensure user can only access chats for their orders:**

```typescript
@SubscribeMessage('join_order_chat')
async handleJoinChat(
  @ConnectedSocket() client: Socket,
  @MessageBody() data: { orderId: string },
) {
  const user = client.data.user;
  
  // Check if user is part of this order
  const order = await this.ordersService.findOne(data.orderId);
  
  if (order.clientId !== user.id && order.contractorId !== user.id) {
    throw new WsException('You do not have access to this chat');
  }
  
  // Join order-specific room
  client.join(`order:${data.orderId}`);
  
  return { success: true };
}
```

---

## ðŸ”„ **Reconnection Logic**

### Client-Side Reconnection

```typescript
// Frontend: Socket.io client with automatic reconnection
import { io, Socket } from 'socket.io-client';

class ChatService {
  private socket: Socket;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 10;

  connect(accessToken: string) {
    this.socket = io(process.env.NEXT_PUBLIC_WS_URL + '/chat', {
      auth: {
        token: accessToken,
      },
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      reconnectionAttempts: this.maxReconnectAttempts,
    });

    // Handle connection
    this.socket.on('connect', () => {
      console.log('Connected to chat server');
      this.reconnectAttempts = 0;
      this.onReconnect();
    });

    // Handle disconnection
    this.socket.on('disconnect', (reason) => {
      console.log('Disconnected:', reason);
      
      if (reason === 'io server disconnect') {
        // Server disconnected us, need to reconnect manually
        this.socket.connect();
      }
    });

    // Handle reconnection attempts
    this.socket.on('reconnect_attempt', (attempt) => {
      console.log(`Reconnection attempt ${attempt}`);
      this.reconnectAttempts = attempt;
    });

    // Handle reconnection error
    this.socket.on('reconnect_error', (error) => {
      console.error('Reconnection error:', error);
    });

    // Handle reconnection failed
    this.socket.on('reconnect_failed', () => {
      console.error('Reconnection failed');
      this.showReconnectionError();
    });
  }

  private async onReconnect() {
    // Re-join active chats
    const activeOrderIds = this.getActiveOrderIds();
    
    for (const orderId of activeOrderIds) {
      this.socket.emit('join_order_chat', { orderId });
    }
    
    // Sync missed messages
    await this.syncMissedMessages();
  }

  private async syncMissedMessages() {
    // Fetch messages missed during offline period
    const lastMessageTimestamp = this.getLastMessageTimestamp();
    
    for (const orderId of this.getActiveOrderIds()) {
      const missedMessages = await api.get(`/chat/${orderId}/messages`, {
        params: { since: lastMessageTimestamp },
      });
      
      if (missedMessages.data.length > 0) {
        this.addMissedMessages(orderId, missedMessages.data);
        this.showNewMessagesNotification(missedMessages.data.length);
      }
    }
  }
}
```

### Server-Side Session Management

**Store connection state in Redis:**

```typescript
@Injectable()
export class ChatSessionService {
  constructor(@InjectRedis() private redis: Redis) {}

  /**
   * Track user's active socket connections
   */
  async addConnection(userId: string, socketId: string): Promise<void> {
    await this.redis.sadd(`user:${userId}:sockets`, socketId);
    await this.redis.expire(`user:${userId}:sockets`, 86400); // 24 hours
  }

  async removeConnection(userId: string, socketId: string): Promise<void> {
    await this.redis.srem(`user:${userId}:sockets`, socketId);
  }

  async getUserConnections(userId: string): Promise<string[]> {
    return this.redis.smembers(`user:${userId}:sockets`);
  }

  async isUserOnline(userId: string): Promise<boolean> {
    const connections = await this.getUserConnections(userId);
    return connections.length > 0;
  }

  /**
   * Store last seen timestamp
   */
  async updateLastSeen(userId: string): Promise<void> {
    await this.redis.set(
      `user:${userId}:last_seen`,
      Date.now().toString(),
      'EX',
      86400,
    );
  }

  async getLastSeen(userId: string): Promise<number | null> {
    const lastSeen = await this.redis.get(`user:${userId}:last_seen`);
    return lastSeen ? parseInt(lastSeen) : null;
  }
}
```

### Message Queue for Offline Users

**Store messages for offline users:**

```typescript
@Injectable()
export class ChatService {
  async sendMessage(data: SendMessageDto): Promise<ChatMessage> {
    // Moderate message
    const moderated = this.moderationService.moderateMessage(data.content);
    
    // Save to database
    const message = await this.prisma.chatMessage.create({
      data: {
        orderId: data.orderId,
        senderId: data.senderId,
        recipientId: data.recipientId,
        content: moderated.content,
        originalContent: data.content,
        isModerated: moderated.isModerated,
        moderationFlags: moderated.flags,
      },
    });
    
    // Check if recipient is online
    const isOnline = await this.chatSessionService.isUserOnline(data.recipientId);
    
    if (isOnline) {
      // Send via WebSocket
      this.chatGateway.sendMessageToUser(data.recipientId, message);
    } else {
      // Queue for delivery when user comes online
      await this.queueOfflineMessage(data.recipientId, message);
      
      // Send push notification
      await this.notificationsQueue.add('send-push', {
        userId: data.recipientId,
        title: 'New message',
        message: `${message.senderName}: ${moderated.content.slice(0, 50)}...`,
      });
    }
    
    return message;
  }

  private async queueOfflineMessage(userId: string, message: ChatMessage): Promise<void> {
    await this.redis.lpush(`user:${userId}:offline_messages`, JSON.stringify(message));
    await this.redis.expire(`user:${userId}:offline_messages`, 86400 * 7); // 7 days
  }

  async getOfflineMessages(userId: string): Promise<ChatMessage[]> {
    const messages = await this.redis.lrange(`user:${userId}:offline_messages`, 0, -1);
    await this.redis.del(`user:${userId}:offline_messages`);
    
    return messages.map((m) => JSON.parse(m));
  }
}
```

### Handling Multiple Device Connections

**Support user connected from multiple devices:**

```typescript
@WebSocketGateway()
export class ChatGateway {
  @SubscribeMessage('send_message')
  async handleSendMessage(
    @ConnectedSocket() client: Socket,
    @MessageBody() data: SendMessageDto,
  ) {
    const message = await this.chatService.sendMessage({
      ...data,
      senderId: client.data.user.id,
    });

    // Emit to sender's OTHER devices (sync across devices)
    const senderConnections = await this.chatSessionService.getUserConnections(client.data.user.id);
    
    for (const socketId of senderConnections) {
      if (socketId !== client.id) {
        this.server.to(socketId).emit('message_sent', message);
      }
    }

    // Emit to recipient's ALL devices
    const recipientConnections = await this.chatSessionService.getUserConnections(data.recipientId);
    
    for (const socketId of recipientConnections) {
      this.server.to(socketId).emit('new_message', message);
    }

    return message;
  }
}
```

---

## ðŸ“± **Handling Network Changes (Mobile)**

### Detect Network Status

```typescript
// Frontend: Detect network status changes
class ChatService {
  private isOnline = true;

  constructor() {
    // Listen to network status
    window.addEventListener('online', () => this.handleOnline());
    window.addEventListener('offline', () => this.handleOffline());
  }

  private handleOnline() {
    console.log('Network back online');
    this.isOnline = true;
    
    // Reconnect socket
    if (!this.socket.connected) {
      this.socket.connect();
    }
    
    // Sync pending messages
    this.syncPendingMessages();
  }

  private handleOffline() {
    console.log('Network offline');
    this.isOnline = false;
    
    // Show offline indicator
    this.showOfflineIndicator();
  }

  private async syncPendingMessages() {
    // Send messages that were queued while offline
    const pendingMessages = this.getPendingMessages();
    
    for (const message of pendingMessages) {
      try {
        await this.sendMessage(message);
        this.removePendingMessage(message.id);
      } catch (error) {
        console.error('Failed to send pending message:', error);
      }
    }
  }
}
```

### Optimistic UI Updates

```typescript
// Show message immediately, then confirm
async sendMessage(content: string, orderId: string) {
  const tempMessage = {
    id: `temp-${Date.now()}`,
    content,
    orderId,
    senderId: currentUserId,
    createdAt: new Date(),
    status: 'sending',
  };
  
  // Add to UI immediately
  this.addMessageToUI(tempMessage);
  
  try {
    // Send to server
    const confirmedMessage = await this.chatService.sendMessage({ content, orderId });
    
    // Replace temp message with confirmed
    this.replaceMessage(tempMessage.id, confirmedMessage);
  } catch (error) {
    // Mark as failed
    this.markMessageAsFailed(tempMessage.id);
    
    // Allow retry
    this.showRetryButton(tempMessage.id);
  }
}
```

---

## ðŸ”” **Unread Message Count**

### Track Unread Messages

```typescript
@Injectable()
export class ChatService {
  async incrementUnreadCount(orderId: string, userId: string): Promise<void> {
    await this.prisma.chat.update({
      where: { orderId },
      data: {
        unreadCount: {
          increment: { [userId]: 1 },
        },
      },
    });
    
    // Update user's total unread count in Redis
    await this.redis.incr(`user:${userId}:unread_total`);
    
    // Emit unread count update
    this.chatGateway.emitUnreadCountUpdate(userId);
  }

  async markAsRead(orderId: string, userId: string): Promise<void> {
    const chat = await this.prisma.chat.findUnique({ where: { orderId } });
    const currentUnread = chat.unreadCount[userId] || 0;
    
    await this.prisma.chat.update({
      where: { orderId },
      data: {
        unreadCount: {
          set: { ...chat.unreadCount, [userId]: 0 },
        },
      },
    });
    
    // Update Redis
    await this.redis.decrby(`user:${userId}:unread_total`, currentUnread);
    
    // Mark messages as read
    await this.prisma.chatMessage.updateMany({
      where: {
        orderId,
        recipientId: userId,
        status: { in: ['sent', 'delivered'] },
      },
      data: {
        status: 'read',
        readAt: new Date(),
      },
    });
    
    // Emit read receipt
    this.chatGateway.emitReadReceipt(orderId, userId);
  }
}
```

---

**Last updated:** November 2, 2025  
**Status:** Complete with WebSocket security and reconnection logic  
**Priority:** HIGH