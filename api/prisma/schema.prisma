// Prisma Schema for Hummii Platform
// Database: PostgreSQL with PostGIS extension
// Last Updated: January 2025

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  CLIENT
  CONTRACTOR
  ADMIN
}

enum OrderStatus {
  DRAFT
  PUBLISHED
  IN_PROGRESS
  PENDING_REVIEW
  COMPLETED
  CANCELLED
  DISPUTED
}

enum OrderType {
  PUBLIC
  DIRECT
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
  DISPUTED
}

enum SubscriptionTier {
  FREE
  STANDARD
  PROFESSIONAL
  ADVANCED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
  UNPAID
}

enum VerificationStatus {
  PENDING
  IN_REVIEW
  VERIFIED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
  SUSPENDED
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  FAKE
  OFFENSIVE
  CONTACT_INFO
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
  DISMISSED
}

enum DisputeReason {
  WORK_NOT_COMPLETED
  WORK_QUALITY_ISSUES
  LATE_COMPLETION
  DIFFERENT_FROM_DESCRIPTION
  CONTRACTOR_UNRESPONSIVE
  CLIENT_CHANGED_REQUIREMENTS
  SAFETY_CONCERNS
  FRAUDULENT_ACTIVITY
  INAPPROPRIATE_BEHAVIOR
  OTHER
}

enum DisputeStatus {
  OPENED
  UNDER_REVIEW
  AWAITING_INFO
  RESOLVED
  CLOSED
}

enum DisputeResolution {
  BLOCK_USER
  SUSPEND_ACCOUNT
  CLOSE_ORDER
  WARN_USER
  NO_ACTION
}

enum DisputePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum EvidenceType {
  PHOTO
  SCREENSHOT
  DOCUMENT
  CONTRACT
  COMMUNICATION
  RECEIPT
  OTHER
}

enum NotificationType {
  ORDER_STATUS_CHANGED
  NEW_PROPOSAL
  PROPOSAL_ACCEPTED
  PROPOSAL_REJECTED
  MESSAGE_RECEIVED
  PAYMENT_RECEIVED
  REVIEW_SUBMITTED
  REVIEW_RESPONSE
  DISPUTE_OPENED
  DISPUTE_STATUS_CHANGED
  DISPUTE_RESOLVED
  VERIFICATION_STATUS
  SECURITY_ALERT
  SYSTEM_ANNOUNCEMENT
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  PAYMENT_FAILED
}

enum NotificationPriority {
  HIGH
  MEDIUM
  LOW
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

// ============================================================================
// USER MODELS
// ============================================================================

model User {
  id         String     @id @default(uuid())
  email      String     @unique
  password   String
  name       String
  phone      String?
  avatar     String? // Legacy field - kept for backward compatibility
  avatarId   String? // Cloudflare Images ID
  avatarUrl  String? // Full Cloudflare Images URL with variant
  roles      UserRole[] @default([CLIENT])
  isVerified Boolean    @default(false)

  // Email verification
  verificationToken       String?
  verificationTokenExpiry DateTime?

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?

  // Cookie preferences (PIPEDA compliance)
  cookiePreferences Json? // { essential: boolean, functional: boolean, analytics: boolean, marketing: boolean }

  // Contractor specific
  contractor Contractor?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete for PIPEDA compliance

  // Relations
  clientOrders            Order[]                  @relation("ClientOrders")
  contractorOrders        Order[]                  @relation("ContractorOrders")
  sentMessages            Message[]                @relation("SentMessages")
  receivedMessages        Message[]                @relation("ReceivedMessages")
  reviewsGiven            Review[]                 @relation("ReviewsGiven")
  reviewsReceived         Review[]                 @relation("ReviewsReceived")
  reviewsModerated        Review[]                 @relation("ReviewsModerated")
  reportsGiven            ReviewReport[]           @relation("ReportsGiven")
  reportsReviewed         ReviewReport[]           @relation("ReportsReviewed")
  notifications           Notification[]
  notificationPreferences NotificationPreferences?
  sessions                Session[]
  auditLogs               AuditLog[]               @relation("AuditLogs")
  ratingStats             UserRatingStats?
  disputesInitiated       Dispute[]                @relation("DisputesInitiated")
  disputesResponded       Dispute[]                @relation("DisputesResponded")
  disputesResolved        Dispute[]                @relation("DisputesResolved")
  disputeEvidence         DisputeEvidence[]
  disputeMessages         DisputeMessage[]

  // Analytics relations
  analytics           UserAnalytics?       @relation("UserAnalytics")
  contractorAnalytics ContractorAnalytics? @relation("ContractorAnalytics")

  @@index([email])
  @@index([phone])
  @@map("users")
}

model Contractor {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Profile
  bio          String?  @db.Text
  experience   Int? // Years of experience
  hourlyRate   Decimal? @db.Decimal(10, 2)
  businessName String?

  // Location (simple lat/lon for MVP, PostGIS later)
  latitude      Float?
  longitude     Float?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  serviceRadius Int     @default(50) // km

  // Verification
  verificationStatus      VerificationStatus @default(PENDING)
  verificationDate        DateTime?
  stripeIdentitySessionId String?

  // Statistics
  totalOrders     Int      @default(0)
  completedOrders Int      @default(0)
  rating          Decimal? @db.Decimal(3, 2) // 0.00 to 5.00
  reviewCount     Int      @default(0)

  // Availability
  isAvailable Boolean @default(true)

  // Relations
  categories   ContractorCategory[]
  portfolio    PortfolioItem[]
  services     Service[]
  proposals    Proposal[]
  subscription Subscription?
  slug         ContractorSlug?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contractors")
}

model Category {
  id          String  @id @default(uuid())
  name        String  @unique // Legacy field - kept for backward compatibility
  nameEn      String // English name (required)
  nameFr      String // French name (required)
  slug        String  @unique
  description String? @db.Text
  icon        String?

  // Hierarchy
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  // Metadata
  level     Int     @default(0) // 0 = root, 1+ = subcategory
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  createdBy String? // Admin user ID for audit trail

  // Relations
  contractors ContractorCategory[]
  orders      Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([level])
  @@index([isActive])
  @@index([sortOrder])
  @@map("categories")
}

model ContractorCategory {
  contractorId String
  categoryId   String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  category     Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Metadata
  isPrimary Boolean  @default(false) // Main category for contractor
  createdAt DateTime @default(now())

  @@id([contractorId, categoryId])
  @@map("contractor_categories")
}

model PortfolioItem {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  title       String
  description String?  @db.Text
  images      String[] // Array of image URLs
  order       Int      @default(0) // Display order

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("portfolio_items")
}

model Service {
  id           String     @id @default(uuid())
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  name        String
  description String?  @db.Text
  price       Decimal? @db.Decimal(10, 2)
  unit        String? // e.g., "per hour", "per project"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("services")
}

// ============================================================================
// ORDER MODELS
// ============================================================================

model Order {
  id String @id @default(uuid())

  // Order details
  title       String
  description String      @db.Text
  images      String[] // Array of image URLs
  type        OrderType   @default(PUBLIC)
  status      OrderStatus @default(DRAFT)

  // Category
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  // Parties
  clientId     String
  client       User    @relation("ClientOrders", fields: [clientId], references: [id])
  contractorId String?
  contractor   User?   @relation("ContractorOrders", fields: [contractorId], references: [id])

  // Location (Haversine search - simple lat/lon)
  latitude   Float?
  longitude  Float?
  address    String
  city       String
  province   String
  postalCode String

  // Budget
  budget      Decimal? @db.Decimal(10, 2)
  agreedPrice Decimal? @db.Decimal(10, 2)

  // Dates
  deadline    DateTime?
  publishedAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Review eligibility
  isReviewEligible Boolean   @default(false)
  reviewDeadline   DateTime?

  // Relations
  proposals Proposal[]
  messages  Message[]
  review    Review?
  payment   Payment?
  dispute   Dispute?

  // Analytics
  analytics OrderAnalytics? @relation("OrderAnalytics")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([clientId])
  @@index([contractorId])
  @@index([status])
  @@index([categoryId])
  @@index([latitude, longitude])
  @@map("orders")
}

model Proposal {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  message       String  @db.Text
  proposedPrice Decimal @db.Decimal(10, 2)
  estimatedDays Int?

  status    ProposalStatus @default(PENDING)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, contractorId])
  @@index([contractorId])
  @@index([status])
  @@map("proposals")
}

// ============================================================================
// CHAT MODELS
// ============================================================================

model ChatRoom {
  id      String @id @default(uuid())
  orderId String @unique

  messages Message[]

  createdAt DateTime  @default(now())
  closedAt  DateTime? // Auto-close 30 days after order completion

  @@map("chat_rooms")
}

model Message {
  id String @id @default(uuid())

  roomId String
  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id])

  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])

  content String @db.Text

  // Moderation
  isModerated     Boolean @default(false)
  moderationFlags Json? // {phone: true, email: false, etc}

  // Status
  isRead   Boolean   @default(false)
  readAt   DateTime?
  isEdited Boolean   @default(false)
  editedAt DateTime?

  // Order context
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())

  @@map("messages")
}

// ============================================================================
// REVIEW MODELS
// ============================================================================

model Review {
  id String @id @default(uuid())

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Participants
  reviewerId String // User who leaves review
  reviewer   User   @relation("ReviewsGiven", fields: [reviewerId], references: [id])

  revieweeId String // User being reviewed
  reviewee   User   @relation("ReviewsReceived", fields: [revieweeId], references: [id])

  // Content
  rating          Decimal @db.Decimal(3, 2) // Overall rating (1.00 - 5.00)
  comment         String? @db.Text
  criteriaRatings Json // { quality: 5, professionalism: 4, communication: 5, value: 4 } or { communication: 5, professionalism: 4, payment: 5 }

  // Moderation
  status          ReviewStatus @default(PENDING)
  moderationFlags String[] // ['profanity', 'contact_info', etc.]
  moderatedAt     DateTime?
  moderatedBy     String?
  moderator       User?        @relation("ReviewsModerated", fields: [moderatedBy], references: [id])
  moderationNotes String?      @db.Text

  // Metadata
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  isVisible Boolean   @default(true)

  // Response
  response ReviewResponse?

  // Reports
  reports     ReviewReport[]
  reportCount Int            @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([revieweeId, status])
  @@index([reviewerId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@map("reviews")
}

model ReviewResponse {
  id       String @id @default(uuid())
  reviewId String @unique
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Content
  content String @db.Text

  // Moderation
  status          ReviewStatus @default(PENDING)
  moderationFlags String[]
  moderatedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reviewId])
  @@map("review_responses")
}

model ReviewReport {
  id       String @id @default(uuid())
  reviewId String
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  reporterId String
  reporter   User   @relation("ReportsGiven", fields: [reporterId], references: [id])

  // Report details
  reason      ReportReason
  description String?      @db.Text

  // Status
  status     ReportStatus @default(PENDING)
  reviewedBy String?
  reviewer   User?        @relation("ReportsReviewed", fields: [reviewedBy], references: [id])
  reviewedAt DateTime?
  resolution String?      @db.Text

  createdAt DateTime @default(now())

  @@unique([reviewId, reporterId])
  @@index([status])
  @@index([reviewId])
  @@map("review_reports")
}

model UserRatingStats {
  id       String   @id @default(uuid())
  userId   String   @unique
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userType UserRole // CLIENT or CONTRACTOR

  // Overall statistics
  averageRating Decimal @default(0.00) @db.Decimal(3, 2)
  totalReviews  Int     @default(0)

  // Contractor-specific criteria averages
  avgQuality         Decimal? @db.Decimal(3, 2)
  avgProfessionalism Decimal? @db.Decimal(3, 2)
  avgCommunication   Decimal? @db.Decimal(3, 2)
  avgValue           Decimal? @db.Decimal(3, 2)

  // Client-specific criteria averages
  avgPayment Decimal? @db.Decimal(3, 2)

  // Rating distribution (count of 1-5 star reviews)
  ratingDistribution Json // { "5": 10, "4": 5, "3": 2, "2": 0, "1": 0 }

  // Badges
  badges String[] // ['verified', 'top_pro', 'new']

  // Weighted score (for ranking)
  weightedScore Decimal @default(0.00) @db.Decimal(5, 2)

  updatedAt DateTime @updatedAt

  @@index([averageRating])
  @@index([weightedScore])
  @@index([userId])
  @@map("user_rating_stats")
}

// ============================================================================
// PAYMENT MODELS
// ============================================================================

// Not used in MVP - clients and contractors handle payments directly. Kept for future use.
model Payment {
  id String @id @default(uuid())

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("cad")

  status PaymentStatus @default(PENDING)

  // Stripe
  stripePaymentIntentId String? @unique
  stripeCustomerId      String?
  stripePaymentMethodId String?

  // Escrow
  heldInEscrow Boolean   @default(true)
  releasedAt   DateTime?

  // Refund
  refundAmount Decimal?  @db.Decimal(10, 2)
  refundReason String?
  refundedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

// ============================================================================
// DISPUTE MODELS
// ============================================================================

model Dispute {
  id String @id @default(uuid())

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  // Parties
  initiatedById String
  initiatedBy   User   @relation("DisputesInitiated", fields: [initiatedById], references: [id])
  respondentId  String
  respondent    User   @relation("DisputesResponded", fields: [respondentId], references: [id])

  // Dispute details
  reason      DisputeReason
  description String          @db.Text // min 50, max 2000 chars
  priority    DisputePriority @default(MEDIUM)

  // Status tracking
  status DisputeStatus @default(OPENED)

  // Resolution
  resolutionType   DisputeResolution?
  resolutionReason String?            @db.Text
  resolvedById     String?
  resolvedBy       User?              @relation("DisputesResolved", fields: [resolvedById], references: [id])
  resolvedAt       DateTime?
  adminNotes       String?            @db.Text // Internal admin notes

  // Amount in dispute (for reference only, not used for payments in MVP)
  amountInDispute Decimal? @db.Decimal(10, 2)

  // Relations
  evidence DisputeEvidence[]
  messages DisputeMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([initiatedById])
  @@index([respondentId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("disputes")
}

model DisputeEvidence {
  id String @id @default(uuid())

  disputeId String
  dispute   Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  // File details
  fileKey  String // S3 key
  fileUrl  String // Signed URL (temporary)
  fileSize Int // Bytes
  mimeType String
  fileHash String // SHA-256 hash

  // Evidence details
  evidenceType EvidenceType
  description  String?      @db.Text // max 500 chars

  // Security
  virusScanStatus String? @default("pending") // pending, clean, infected
  virusScanResult String?

  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([disputeId])
  @@index([uploadedById])
  @@map("dispute_evidence")
}

model DisputeMessage {
  id String @id @default(uuid())

  disputeId String
  dispute   Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id])

  message    String  @db.Text // min 1, max 2000 chars
  isInternal Boolean @default(false) // admin-only messages

  createdAt DateTime @default(now())

  @@index([disputeId])
  @@index([senderId])
  @@map("dispute_messages")
}

// ============================================================================
// NOTIFICATION MODELS
// ============================================================================

model Notification {
  id        String                @id @default(uuid())
  userId    String
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  priority  NotificationPriority  @default(MEDIUM)
  title     String                @db.VarChar(255)
  body      String                @db.Text
  actionUrl String?               @db.VarChar(500) // Deep link for mobile
  metadata  Json? // Additional data
  isRead    Boolean               @default(false)
  readAt    DateTime?
  channels  NotificationChannel[] // Channels through which notification was sent
  sentAt    DateTime? // When notification was sent
  createdAt DateTime              @default(now())
  expiresAt DateTime? // For time-sensitive notifications

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
  @@map("notifications")
}

model NotificationPreferences {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email settings
  emailEnabled      Boolean @default(true)
  emailOrderUpdates Boolean @default(true)
  emailNewProposals Boolean @default(true)
  emailMessages     Boolean @default(true)
  emailPayments     Boolean @default(true)
  emailReviews      Boolean @default(true)
  emailDisputes     Boolean @default(true)
  emailSecurity     Boolean @default(true) // Always true - cannot be disabled
  emailMarketing    Boolean @default(false)
  emailDigest       Boolean @default(true) // Daily digest
  emailDigestTime   String  @default("09:00") // Time in HH:mm format

  // Push settings
  pushEnabled      Boolean @default(true)
  pushOrderUpdates Boolean @default(true)
  pushNewProposals Boolean @default(true)
  pushMessages     Boolean @default(true)
  pushPayments     Boolean @default(true)
  pushReviews      Boolean @default(true)
  pushDisputes     Boolean @default(true)
  pushSecurity     Boolean @default(true) // Always true

  // In-app settings
  inAppEnabled   Boolean @default(true)
  inAppSound     Boolean @default(true)
  inAppVibration Boolean @default(true)

  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

model EmailLog {
  id         String   @id @default(uuid())
  userId     String?
  email      String   @db.VarChar(255)
  subject    String   @db.VarChar(500)
  template   String   @db.VarChar(100)
  status     String   @db.VarChar(50) // sent, failed, bounced
  provider   String   @default("onesignal") // onesignal, sendgrid, etc.
  providerId String?  @db.VarChar(255) // External provider message ID
  error      String?  @db.Text
  sentAt     DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([sentAt])
  @@map("email_logs")
}

// ============================================================================
// SESSION MODELS
// ============================================================================

model Session {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  refreshToken String @unique

  // Device info
  userAgent String?
  ipAddress String?

  expiresAt DateTime

  createdAt DateTime @default(now())

  @@map("sessions")
}

// ============================================================================
// AUDIT LOG MODELS (PIPEDA Compliance)
// ============================================================================

model AuditLog {
  id String @id @default(uuid())

  // User who performed the action (null for system actions)
  userId String?
  user   User?   @relation("AuditLogs", fields: [userId], references: [id], onDelete: SetNull)

  // Action details
  action   String // LOGIN, LOGOUT, REGISTER, PROFILE_UPDATE, DATA_EXPORT, ACCOUNT_DELETE, PASSWORD_RESET, etc.
  entity   String? // User, Order, Payment, etc.
  entityId String? // ID of the affected entity

  // Request context
  ipAddress String?
  userAgent String?

  // Data changes (before/after for updates)
  changes  Json? // { before: {...}, after: {...} }
  metadata Json? // Additional context data

  // Result
  success      Boolean @default(true)
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// SUBSCRIPTION MODELS
// ============================================================================

model Subscription {
  id           String     @id @default(uuid())
  contractorId String     @unique
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  // Stripe references
  stripeCustomerId     String  @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String // Price ID from Stripe

  // Subscription details
  tier   SubscriptionTier   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Billing
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial (optional)
  trialStart DateTime?
  trialEnd   DateTime?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  history   SubscriptionHistory[]
  analytics SubscriptionAnalytics? @relation("SubscriptionAnalytics")

  @@index([contractorId])
  @@index([stripeSubscriptionId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionHistory {
  id             String        @id @default(uuid())
  contractorId   String
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  // Change details
  action   String // CREATED, UPGRADED, DOWNGRADED, CANCELED, RENEWED, PAYMENT_FAILED
  fromTier SubscriptionTier?
  toTier   SubscriptionTier?

  // Stripe reference
  stripeEventId String? @unique

  // Metadata
  reason   String?
  metadata Json?

  createdAt DateTime @default(now())

  @@index([contractorId])
  @@index([subscriptionId])
  @@index([createdAt])
  @@map("subscription_history")
}

// ============================================================================
// SYSTEM SETTINGS & FEATURE FLAGS
// ============================================================================

model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String   @db.Text
  type        String   @db.VarChar(50) // string, number, boolean, json
  category    String   @db.VarChar(100) // general, security, limits, etc.
  description String?  @db.Text
  updatedBy   String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([key])
  @@index([category])
  @@map("system_settings")
}

model FeatureFlag {
  id                String   @id @default(uuid())
  name              String   @unique
  enabled           Boolean  @default(false)
  rolloutPercentage Int      @default(0) // 0-100, percentage of users to enable for
  description       String?  @db.Text
  updatedBy         String?
  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())

  @@index([name])
  @@index([enabled])
  @@map("feature_flags")
}

// ============================================================================
// SEO MODELS
// ============================================================================

model ContractorSlug {
  id           String   @id @default(cuid())
  contractorId String   @unique
  slug         String   @unique
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isActive])
  @@map("contractor_slugs")
}

model UrlRedirect {
  id         String   @id @default(cuid())
  fromPath   String   @unique
  toPath     String
  statusCode Int      @default(301)
  createdAt  DateTime @default(now())

  @@index([fromPath])
  @@index([toPath])
  @@map("url_redirects")
}

// ============================================================================
// ANALYTICS MODELS (PIPEDA Compliant - No PII)
// ============================================================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventType String // 'profile_view', 'search', 'conversion', 'order_view'
  sessionId String // Anonymous session (NOT user ID)
  entityId  String? // Contractor ID, Order ID (if relevant)
  metadata  Json? // Event-specific data (NO PII)
  ipHash    String? // Hashed IP (SHA-256) for geolocation only
  userAgent String? // Browser info (anonymized)
  createdAt DateTime @default(now())

  @@index([eventType, createdAt])
  @@index([sessionId])
  @@index([entityId])
  @@index([createdAt])
  @@map("analytics_events")
}

model SearchAnalytics {
  id        String   @id @default(cuid())
  query     String // Search term (anonymized if PII detected)
  category  String?
  location  String? // City/region only (NO full address)
  results   Int // Number of results
  sessionId String // Anonymous session
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([category])
  @@index([location])
  @@map("search_analytics")
}

// ============================================================================
// USER LIFECYCLE ANALYTICS (PIPEDA-compliant)
// ============================================================================

model UserAnalytics {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserAnalytics", fields: [userId], references: [id], onDelete: Cascade)

  // Registration tracking
  registrationSource String? // organic, referral, paid, social, google_oauth
  referralCode       String?
  utmSource          String?
  utmMedium          String?
  utmCampaign        String?
  utmContent         String?
  utmTerm            String?

  // Onboarding milestones
  emailVerifiedAt       DateTime?
  profileCompletedAt    DateTime?
  firstOrderCreatedAt   DateTime?
  firstProposalSentAt   DateTime?
  firstOrderCompletedAt DateTime?

  // Engagement metrics
  lastActiveAt           DateTime?
  totalSessions          Int       @default(0)
  totalSessionDuration   Int       @default(0) // seconds
  averageSessionDuration Float?

  // Feature usage (anonymized counts)
  featuresUsed Json? // { search: 20, chat: 5, profile_views: 10 }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([registrationSource])
  @@index([createdAt])
  @@map("user_analytics")
}

// ============================================================================
// ORDER LIFECYCLE ANALYTICS
// ============================================================================

model OrderAnalytics {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation("OrderAnalytics", fields: [orderId], references: [id], onDelete: Cascade)

  // Timing metrics (in seconds)
  createdToDraftDuration Int?
  draftToPublishDuration Int?
  publishToFirstProposal Int?
  publishToAcceptance    Int?
  acceptanceToStart      Int?
  startToCompletion      Int?
  totalDuration          Int?

  // Proposal statistics
  totalProposals       Int      @default(0)
  averageProposalPrice Decimal? @db.Decimal(10, 2)
  lowestProposalPrice  Decimal? @db.Decimal(10, 2)
  highestProposalPrice Decimal? @db.Decimal(10, 2)
  acceptedProposalRank Int? // 1 = lowest price, etc.

  // Engagement metrics
  viewCount       Int @default(0)
  uniqueViewCount Int @default(0)

  // Outcome tracking
  completionStatus   String? // completed, cancelled, disputed, expired
  cancellationReason String?
  disputeReason      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([completionStatus])
  @@index([createdAt])
  @@map("order_analytics")
}

// ============================================================================
// CONTRACTOR PERFORMANCE ANALYTICS
// ============================================================================

model ContractorAnalytics {
  id           String @id @default(uuid())
  contractorId String @unique
  contractor   User   @relation("ContractorAnalytics", fields: [contractorId], references: [id], onDelete: Cascade)

  // Profile performance
  profileViews         Int    @default(0)
  profileViewsUnique   Int    @default(0)
  profileToContactRate Float? // Click-through rate

  // Proposal metrics
  proposalsSubmitted     Int    @default(0)
  proposalsAccepted      Int    @default(0)
  proposalsRejected      Int    @default(0)
  proposalAcceptanceRate Float? // Calculated: accepted / submitted
  averageResponseTime    Int? // Average time to submit proposal (seconds)

  // Order performance
  ordersCompleted       Int    @default(0)
  ordersOnTime          Int    @default(0)
  ordersCancelled       Int    @default(0)
  averageCompletionTime Int? // Average vs estimated time
  onTimeDeliveryRate    Float? // Percentage

  // Revenue tracking
  totalRevenue      Decimal  @default(0) @db.Decimal(10, 2)
  averageOrderValue Decimal? @db.Decimal(10, 2)

  // Quality metrics
  averageRating Float?
  totalReviews  Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractorId])
  @@index([proposalAcceptanceRate])
  @@index([averageRating])
  @@map("contractor_analytics")
}

// ============================================================================
// SUBSCRIPTION ANALYTICS (Revenue tracking)
// ============================================================================

model SubscriptionAnalytics {
  id             String       @id @default(uuid())
  subscriptionId String       @unique
  subscription   Subscription @relation("SubscriptionAnalytics", fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Trial conversion tracking
  trialStartedAt      DateTime?
  trialConvertedAt    DateTime?
  trialDroppedAt      DateTime?
  trialDurationDays   Int?
  didConvertFromTrial Boolean   @default(false)

  // Revenue metrics
  lifetimeValue       Decimal  @default(0) @db.Decimal(10, 2)
  monthsActive        Int      @default(0)
  totalPaid           Decimal  @default(0) @db.Decimal(10, 2)
  averageMonthlyValue Decimal? @db.Decimal(10, 2)

  // Churn tracking
  churnedAt         DateTime?
  churnReason       String? // cancelled, payment_failed, downgraded_to_free
  monthsBeforeChurn Int?
  wasReactivated    Boolean   @default(false)
  reactivationCount Int       @default(0)

  // Tier changes
  upgradeCount     Int       @default(0)
  downgradeCount   Int       @default(0)
  lastTierChangeAt DateTime?

  // Payment health
  paymentFailures      Int       @default(0)
  lastPaymentFailureAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([churnedAt])
  @@index([didConvertFromTrial])
  @@map("subscription_analytics")
}

// ============================================================================
// DAILY REVENUE METRICS (Aggregated snapshots)
// ============================================================================

model RevenueMetrics {
  id   String   @id @default(uuid())
  date DateTime @unique @db.Date

  // MRR/ARR calculations
  mrr Decimal @default(0) @db.Decimal(10, 2) // Monthly Recurring Revenue
  arr Decimal @default(0) @db.Decimal(10, 2) // Annual Recurring Revenue

  // Subscription counts by tier
  activeSubscriptions Int @default(0)
  freeUsers           Int @default(0)
  standardUsers       Int @default(0)
  professionalUsers   Int @default(0)
  advancedUsers       Int @default(0)

  // Daily changes
  newSubscriptions      Int @default(0)
  canceledSubscriptions Int @default(0)
  upgrades              Int @default(0)
  downgrades            Int @default(0)

  // Churn metrics
  churnRate    Float   @default(0) // Percentage
  revenueChurn Decimal @default(0) @db.Decimal(10, 2)

  // Trial metrics
  activeTrials        Int    @default(0)
  trialConversions    Int    @default(0)
  trialConversionRate Float? // Percentage

  // User engagement
  dailyActiveUsers   Int @default(0)
  weeklyActiveUsers  Int @default(0)
  monthlyActiveUsers Int @default(0)

  // Order metrics
  ordersCreated     Int      @default(0)
  ordersCompleted   Int      @default(0)
  averageOrderValue Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([date])
  @@map("revenue_metrics")
}
