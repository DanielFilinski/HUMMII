---
alwaysApply: false
auto:
  - "*.md"
  - "docker-compose*.yml"
  - "Dockerfile"
  - ".env*"
  - "start.sh"
  - "package.json"
---

# Development & Operations Guide

> **Development, Docker, and project operations**
> **Version:** 1.0 | **Updated:** October 27, 2025

## Quick Start Commands

### Docker Commands

```bash
# Start all services
docker compose up -d

# Stop all services
docker compose down

# Restart specific service
docker compose restart api

# View logs
docker compose logs -f api
docker compose logs --tail=100 api

# Check status
docker compose ps

# Execute command in container
docker compose exec api pnpm run migration:run
docker compose exec postgres psql -U hummii -d hummii_dev

# Rebuild containers
docker compose up -d --build
docker compose build api

# Clean up (CAREFUL: removes all data)
docker compose down -v
```

### Code Quality Commands

```bash
# Lint, format, type-check
pnpm run lint          # ESLint
pnpm run format        # Prettier
pnpm run type-check    # TypeScript

# Auto-fix
pnpm run lint --fix
pnpm run format --write

# Testing
pnpm run test          # Unit tests
pnpm run test:watch    # Watch mode
pnpm run test:cov      # Coverage
pnpm run test:e2e      # E2E tests (backend)
```

### Database Commands (Backend)

```bash
cd api

# Migrations
pnpm run migration:generate -- -n MigrationName
pnpm run migration:run
pnpm run migration:revert

# Prisma
pnpm run prisma:generate     # Generate Prisma client
pnpm run prisma:studio       # Open Prisma Studio GUI (http://localhost:5555)
pnpm run prisma migrate reset # Reset DB (CAREFUL: deletes all data!)

# Seed database
pnpm run seed
```

## Environment Setup

### Required Environment Variables

Key variables from `.env.example` (251 lines):

```bash
# General
NODE_ENV=development
PORT=3000
APP_URL=http://localhost:3001

# Database
DATABASE_URL="postgresql://hummii:password@localhost:5432/hummii_dev"

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT Secrets (generate with: openssl rand -base64 64)
JWT_ACCESS_SECRET=your-256-bit-secret
JWT_REFRESH_SECRET=your-256-bit-secret
JWT_ACCESS_EXPIRATION=15m
JWT_REFRESH_EXPIRATION=7d

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLIC_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Google Maps
GOOGLE_MAPS_API_KEY=AIza...

# OneSignal
ONESIGNAL_APP_ID=...
ONESIGNAL_API_KEY=...

# Twilio
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
TWILIO_PHONE_NUMBER=...
```

### Service URLs (After Docker Start)

| Service | URL | Description |
|--------|-----|-------------|
| API | http://localhost:3000 | Backend NestJS |
| Swagger | http://localhost:3000/api | API documentation |
| Frontend | http://localhost:3001 | Next.js application |
| Admin | http://localhost:3002 | Admin panel Refine |
| PgAdmin | http://localhost:5050 | PostgreSQL GUI (optional) |
| Redis Commander | http://localhost:8081 | Redis GUI (optional) |

## Troubleshooting

### Docker Issues

**Problem: Containers not starting**

```bash
# Solution 1: Remove volumes and rebuild
docker compose down -v
docker compose up --build

# Solution 2: Check logs
docker compose logs api
docker compose logs postgres

# Solution 3: Check resources
docker stats
```

**Problem: Port already in use**

```bash
# Find process on port 3000
lsof -ti:3000

# Kill process
lsof -ti:3000 | xargs kill -9

# Or change port in .env
API_PORT=3001
```

**Problem: Database connection errors**

```bash
# Check PostgreSQL logs
docker compose logs postgres

# Restart PostgreSQL
docker compose restart postgres

# Check environment variables
docker compose exec api env | grep DATABASE
```

### Database Issues

**Problem: Migration not applying**

```bash
cd api

# Revert last migration
pnpm run migration:revert

# Fix migration file
# prisma/migrations/...

# Apply again
pnpm run migration:run
```

**Problem: Prisma schema not synced**

```bash
# Regenerate Prisma client
pnpm run prisma:generate

# Apply migrations
pnpm run migration:run

# If problem persists, reset DB
pnpm run prisma migrate reset
```

### Next.js Issues

**Problem: Build fails with type errors**

```bash
cd frontend

# Clear Next.js cache
rm -rf .next

# Clear node_modules cache
rm -rf node_modules/.cache

# Check TypeScript errors
pnpm run type-check

# Rebuild
pnpm run build
```

**Problem: Hydration errors**

```typescript
// Check for client-only code in server components
// Add 'use client' directive when needed
'use client';

export default function Page() {
  const user = useUser(); // ✅ Hook in Client Component
  return <div>{user.name}</div>;
}
```

### API Issues

**Problem: CORS errors**

```typescript
// api/src/main.ts
app.enableCors({
  origin: process.env.FRONTEND_URL,
  credentials: true,
});
```

**Problem: JWT token invalid**

```bash
# Check secrets in .env
echo $JWT_ACCESS_SECRET
echo $JWT_REFRESH_SECRET

# Generate new secrets
openssl rand -base64 64

# Update .env and restart API
docker compose restart api
```

## Git Workflow

### Commit Convention

```bash
# Format
<type>(<scope>): <subject>

# Types
feat      # New feature
fix       # Bug fix
docs      # Documentation
style     # Code formatting
refactor  # Code refactoring
test      # Tests
chore     # Maintenance
perf      # Performance
security  # Security fixes
ci        # CI/CD changes

# Scopes
api       # Backend API
frontend  # Frontend
admin     # Admin panel
docker    # Docker
docs      # Documentation
deps      # Dependencies

# Examples
feat(api): add user authentication endpoint
fix(frontend): resolve navigation bug on mobile
docs: update installation instructions
security(api): fix SQL injection vulnerability
```

### Pre-commit Checks

Automatic checks before commit (Husky):
- ESLint
- Prettier
- TypeScript type check
- Unit tests for changed files

## Useful Commands

```bash
# Check all environment variables
cat .env | grep -v "^#" | grep -v "^$"

# Test external services
curl -X POST https://api.stripe.com/v1/customers \
  -u $STRIPE_SECRET_KEY:

# Check Docker resource usage
docker stats

# Check database size
docker exec hummii-postgres psql -U hummii -d hummii_dev \
  -c "SELECT pg_size_pretty(pg_database_size('hummii_dev'));"

# Clear Docker logs
docker system prune --volumes
```

## Adding New Features

### New API Module

```bash
cd api

# 1. Generate module, controller, service
nest g module users
nest g controller users
nest g service users

# 2. Create DTOs
mkdir src/users/dto
touch src/users/dto/create-user.dto.ts

# 3. Update Prisma schema
nano prisma/schema.prisma

# 4. Generate and apply migration
pnpm run migration:generate -- -n AddUserModel
pnpm run migration:run

# 5. Implement logic in service
# 6. Add tests
# 7. Update Swagger documentation
```

### New Next.js Page

```bash
cd frontend

# 1. Create page file
mkdir -p app/(public)/about
touch app/(public)/about/page.tsx

# 2. Add basic structure with metadata
# 3. Add to navigation
# 4. Test route
```

---

## Monitoring & Observability

### Health Check Endpoints

```bash
# API health endpoints
curl http://localhost:3000/api/health
curl http://localhost:3000/api/health/db
curl http://localhost:3000/api/health/redis
curl http://localhost:3000/api/health/stripe
```

**Implementation:**

```typescript
// api/src/health/health.controller.ts
import { Controller, Get } from '@nestjs/common';
import { HealthCheck, HealthCheckService, PrismaHealthIndicator, HttpHealthIndicator } from '@nestjs/terminus';

@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private db: PrismaHealthIndicator,
    private http: HttpHealthIndicator,
  ) {}

  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.db.pingCheck('database'),
      () => this.http.pingCheck('stripe', 'https://api.stripe.com/healthcheck'),
    ]);
  }

  @Get('db')
  @HealthCheck()
  checkDatabase() {
    return this.health.check([
      () => this.db.pingCheck('database'),
    ]);
  }

  @Get('redis')
  @HealthCheck()
  checkRedis() {
    return this.health.check([
      async () => {
        await this.redis.ping();
        return { redis: { status: 'up' } };
      },
    ]);
  }
}
```

### Metrics to Track

**API Performance:**
- Response times (p50, p95, p99)
- Request rate (requests per second)
- Error rate (4xx, 5xx)
- Active connections

**Database:**
- Query execution time
- Connection pool usage
- Slow queries (>1s)
- Deadlocks

**Redis:**
- Cache hit rate
- Memory usage
- Connected clients
- Command latency

**WebSocket:**
- Active connections
- Messages per second
- Connection errors
- Reconnection rate

**Queue (Bull):**
- Jobs waiting
- Jobs active
- Jobs completed/failed (per hour)
- Job processing time

**Business Metrics:**
- User registrations (per day)
- Orders created/completed (per day)
- Payments processed (total amount)
- Active users (DAU, MAU)
- Stripe payment success rate

### Logging Best Practices

**Log Levels:**

```typescript
// Use appropriate log levels
logger.error('Payment failed', { userId, orderId, error }); // Critical issues
logger.warn('Rate limit approaching', { userId, count }); // Warnings
logger.info('User registered', { userId }); // Important events
logger.debug('Cache hit', { key }); // Debugging info
```

**Structured Logging:**

```typescript
// Winston structured logs
logger.info('Payment processed', {
  userId: payment.userId,
  orderId: payment.orderId,
  amount: payment.amount,
  currency: 'CAD',
  paymentIntentId: payment.paymentIntentId,
  timestamp: new Date().toISOString(),
  correlationId: req.correlationId,
});
```

**Don't Log Sensitive Data:**

```typescript
// ❌ BAD
logger.info('User login', { email: user.email, password: user.password });

// ✅ GOOD
logger.info('User login', {
  userId: user.id,
  email: maskEmail(user.email),
  correlationId: req.correlationId,
});
```

### Error Tracking (Sentry)

**Setup:**

```bash
# Install Sentry
cd api
pnpm add @sentry/node @sentry/tracing
```

**Configuration:**

```typescript
// api/src/main.ts
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1, // 10% of transactions
  integrations: [
    new Sentry.Integrations.Http({ tracing: true }),
    new Sentry.Integrations.Prisma({ client: prisma }),
  ],
  beforeSend(event, hint) {
    // Don't send sensitive data
    if (event.request) {
      delete event.request.cookies;
      delete event.request.headers?.authorization;
    }
    return event;
  },
});

// Global error handler
app.useGlobalFilters(new SentryExceptionFilter());
```

**Manual Error Capture:**

```typescript
try {
  await processPayment(data);
} catch (error) {
  Sentry.captureException(error, {
    tags: {
      module: 'payments',
      userId: user.id,
    },
    extra: {
      orderId: data.orderId,
      amount: data.amount,
    },
  });
  throw error;
}
```

### APM (Application Performance Monitoring)

**Options:**
1. **New Relic** - Full-featured APM
2. **DataDog** - Infrastructure + APM
3. **Elastic APM** - Open-source alternative

**Recommended: New Relic**

```bash
# Install New Relic agent
pnpm add newrelic
```

```typescript
// api/newrelic.js
exports.config = {
  app_name: ['Hummii API'],
  license_key: process.env.NEW_RELIC_LICENSE_KEY,
  distributed_tracing: {
    enabled: true,
  },
  logging: {
    level: 'info',
  },
};

// Import first in main.ts
require('newrelic');
```

### Alerting Policies

**Critical Alerts (immediate):**
- API error rate > 5%
- Database connection failures
- Payment processing failures
- WebSocket disconnections > 100/min
- Queue backlog > 10,000 jobs

**Warning Alerts (review within 1 hour):**
- API response time p95 > 1s
- Cache hit rate < 70%
- Disk usage > 80%
- Memory usage > 85%
- Failed jobs rate > 10%

**Info Alerts (daily digest):**
- User growth
- Daily revenue
- Top errors (grouped)
- Performance trends

### Dashboard Setup (Grafana)

**Install Grafana + Prometheus:**

```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3500:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false

volumes:
  prometheus_data:
  grafana_data:
```

**Prometheus Configuration:**

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'api'
    static_configs:
      - targets: ['api:3000']
    metrics_path: '/metrics'

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

**Expose Metrics Endpoint:**

```typescript
// Install Prometheus client
pnpm add prom-client

// api/src/metrics/metrics.controller.ts
import { Controller, Get, Res } from '@nestjs/common';
import { Response } from 'express';
import { register } from 'prom-client';

@Controller('metrics')
export class MetricsController {
  @Get()
  async getMetrics(@Res() res: Response) {
    res.set('Content-Type', register.contentType);
    res.end(await register.metrics());
  }
}
```

**Custom Metrics:**

```typescript
import { Counter, Histogram } from 'prom-client';

// Count API requests
const httpRequestCounter = new Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code'],
});

// Track response times
const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration in seconds',
  labelNames: ['method', 'route'],
  buckets: [0.1, 0.5, 1, 2, 5],
});

// Usage
httpRequestCounter.inc({ method: 'GET', route: '/api/orders', status_code: 200 });
httpRequestDuration.observe({ method: 'GET', route: '/api/orders' }, 0.234);
```

### Performance Optimization Checklist

- [ ] Database indexes on frequently queried columns
- [ ] Redis caching for hot data
- [ ] CDN for static assets
- [ ] Gzip compression enabled
- [ ] Image optimization (WebP, lazy loading)
- [ ] Code splitting (Next.js automatic)
- [ ] API response pagination
- [ ] Database connection pooling
- [ ] Async/background jobs for heavy tasks
- [ ] Rate limiting to prevent abuse

### Monitoring Commands

```bash
# Check system resources
docker stats

# Check logs
docker compose logs -f api
docker compose logs --tail=100 postgres

# Check database size
docker exec hummii-postgres psql -U hummii -d hummii_dev \
  -c "SELECT pg_size_pretty(pg_database_size('hummii_dev'));"

# Check Redis memory
docker exec hummii-redis redis-cli INFO memory

# Check active connections
docker exec hummii-postgres psql -U hummii -d hummii_dev \
  -c "SELECT count(*) FROM pg_stat_activity;"

# Check slow queries (last hour)
docker exec hummii-postgres psql -U hummii -d hummii_dev \
  -c "SELECT query, mean_exec_time FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;"
```

---

**Last updated:** November 2, 2025
